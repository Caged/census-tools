#!/bin/sh

usage() { echo "Usage: $0 [-d postgres database] [-s shapefile directory] [-c csv data directory]" 1>&2; exit 1; }

while getopts ":d:s:c:p:" opt; do
  case $opt in
    d)
      dbname=$OPTARG
      ;;
    s)
      shapefile_dir=$OPTARG
      ;;
    c)
      csv_dir=$OPTARG
      ;;
    p)
      reproject=$OPTARG
      ;;
    *)
      usage
      ;;
  esac
done

shift $((OPTIND-1))

if [ -z "${dbname}" ] || [ -z "${shapefile_dir}" ]; then
    usage
fi

# Drop and recreate database
dropdb --interactive -e $dbname
createdb --encoding UTF8 $dbname

# Create the POSTGIS extension
psql -d $dbname -c 'CREATE EXTENSION postgis'

# Create some temporary directories
tmp_shapefile_dir=$(mktemp -d -t nhgis)
tmp_reprojected_shapefile_dir=$(mktemp -d -t nhgis)
tmp_data_dir=$(mktemp -d -t nhgis)

tar -xzm --totals -C $tmp_shapefile_dir -f $shapefile_dir

# Cleanup temporary directories
rm -rf $tmp_shapefile_dir
rm -rf $tmp_reprojected_shapefile_dir

